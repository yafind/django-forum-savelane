{% extends 'main/base.html' %}
{% load static %}
{% load emoji_extras %}

{% block title %}{{ thread.title }} – Форум{% endblock %}

{% block content %}
{% emoji_catalog as emoji_catalog %}
<style>
  .tg-compose {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 16px;
  }

  .tg-compose-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .tg-compose-input {
    flex: 1;
  }

  .tg-input-field {
    position: relative;
  }

  .tg-input-tools {
    position: absolute;
    right: 12px;
    bottom: 10px;
    display: flex;
    gap: 8px;
  }

  .tg-icon-btn {
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text);
    width: 34px;
    height: 34px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .tg-icon-btn:hover {
    background: rgba(255, 255, 255, 0.08);
  }

  .tg-compose textarea {
    border-radius: 16px;
    min-height: 64px;
    background: var(--surface-3);
    color: var(--text);
    border: 1px solid var(--border);
    padding-right: 86px;
  }

  .tg-send-btn {
    background: var(--accent);
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 20px rgba(0, 122, 204, 0.35);
    color: #ffffff;
  }

  .tg-send-btn:hover {
    background: var(--accent-strong);
  }
</style>
<div class="container py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
  <h1 class="mb-0 text-truncate">{{ thread.title|emoji_codes }}</h1>

  <div class="d-flex gap-2">
    {% if user.is_staff %}
    <form method="post" action="{% url 'toggle_pin_thread' thread.id %}" class="d-inline">
      {% csrf_token %}
      <button type="submit" class="btn btn-sm {% if thread.is_pinned %}btn-warning{% else %}btn-outline-secondary{% endif %} rounded-pill px-3" aria-label="Toggle pinned">
        <i class="fas fa-thumbtack me-1" aria-hidden="true"></i>
        {% if thread.is_pinned %}Открепить{% else %}Закрепить{% endif %}
      </button>
    </form>
    {% endif %}

    <a href="{% url 'thread_list' thread.subsection.id %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3" aria-label="Back to thread list">
      <i class="fas fa-arrow-left me-1" aria-hidden="true"></i> К темам
    </a>
  </div>
</div>

{% for post in posts %}
<div class="card mb-4 shadow-sm">
  <div class="card-body p-4">
    <!-- Автор + аватар -->
    <div class="d-flex align-items-start mb-3">
      <!-- Аватар -->
      {% with avatar_url=post.author.profile.avatar_url %}
        <img 
          src="{{ avatar_url }}"
          alt="Аватар {{ post.author.username }}"
          class="rounded-circle border border-light me-3"
          width="50"
          height="50"
          loading="lazy"
          onerror="this.onerror=null; this.src='{% static "images/default-avatar.png" %}';"
        >
      {% endwith %}

      <!-- Имя и дата -->
      <div>
        <strong>
          <a href="{% url 'user_profile' post.author.id %}" class="text-decoration-none text-primary hover-underline">
            {{ post.author.username }}
          </a>
        </strong>
        <div class="text-muted small"><time datetime="{{ post.created_at|date:'c' }}">{{ post.created_at|date:"d.m.Y H:i" }}</time></div>
      </div>
    </div>

    <!-- Текст поста -->
    {% if post.text %}
      <div class="mb-3 fs-6 text-white">{{ post.text|emoji_codes }}</div>
    {% endif %}

    <!-- Изображение -->
    {% if post.image %}
      <div class="mt-2">
        <img 
          src="{{ post.image.url }}" 
          alt="Изображение к посту"
          class="img-fluid rounded border"
          style="max-height: 600px; object-fit: contain;"
          loading="lazy"
        >
      </div>
    {% endif %}
  </div>

  <!-- Действия (редактирование для автора, удаление для админа) -->
  {% if user.is_authenticated %}
    {% if post.author == user or user.is_staff %}
    <div class="card-footer bg-light border-top-0 p-3">
      <div class="d-flex gap-2">
        {% if post.author == user %}
          <a href="{% url 'edit_post' post.id %}" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
            <i class="fas fa-edit me-1" aria-hidden="true"></i> Редактировать
          </a>
        {% endif %}
        {% if user.is_staff %}
          <form method="post" action="{% url 'delete_post' post.id %}" onsubmit="return confirm('Удалить сообщение? Действие нельзя отменить.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3">Удалить</button>
          </form>
        {% endif %}
      </div>
    </div>
    {% endif %}
  {% endif %}
</div>
{% endfor %}

<!-- Пагинация -->
{% if posts.has_other_pages %}
<nav aria-label="Посты" class="mt-5">
  <ul class="pagination justify-content-center">
    {% if posts.has_previous %}
      <li class="page-item">
        <a class="page-link rounded-pill" href="?page=1">&laquo; первая</a>
      </li>
      <li class="page-item">
        <a class="page-link rounded-pill" href="?page={{ posts.previous_page_number }}">предыдущая</a>
      </li>
    {% endif %}

    <li class="page-item">
      <span class="page-link bg-light border-0 rounded-pill px-3">
        Стр. {{ posts.number }} из {{ posts.paginator.num_pages }}
      </span>
    </li>

    {% if posts.has_next %}
      <li class="page-item">
        <a class="page-link rounded-pill" href="?page={{ posts.next_page_number }}">следующая</a>
      </li>
      <li class="page-item">
        <a class="page-link rounded-pill" href="?page={{ posts.paginator.num_pages }}">последняя &raquo;</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- Форма нового поста -->
{% if user.is_authenticated %}
  <div class="card mt-5">
    <div class="card-header bg-light">
      <h5 class="mb-0">Новое сообщение</h5>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="post-form" class="tg-compose" action="{% url 'new_post' thread.id %}">
        {% csrf_token %}
        <div class="emoji-panel" data-emoji-panel hidden>
          <div class="emoji-tabs">
            <button type="button" class="emoji-tab is-active" data-emoji-tab="emoji">Emoji</button>
            <button type="button" class="emoji-tab" data-emoji-tab="gif">GIF</button>
          </div>
          <div class="emoji-grid" data-emoji-grid></div>
        </div>
        <div class="mb-3 tg-compose-row">
          <div class="tg-compose-input emoji-wrapper">
            <div class="tg-input-field">
              <div class="emoji-suggest" data-emoji-suggest></div>
              <textarea 
              name="text" 
              class="form-control" 
              rows="3" 
              placeholder="Напишите ваше сообщение..."
              required
              ></textarea>
              <div class="tg-input-tools">
                <button type="button" class="tg-icon-btn" data-emoji-toggle aria-label="Открыть эмодзи">
                  <i class="far fa-smile" aria-hidden="true"></i>
                </button>
              </div>
            </div>
          </div>
          <button type="submit" class="tg-send-btn" aria-label="Отправить сообщение">
            <i class="fas fa-paper-plane" aria-hidden="true"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  {{ emoji_catalog|json_script:"emoji-catalog" }}

  <script>
    const emojiCatalog = JSON.parse(document.getElementById('emoji-catalog').textContent || '[]');

    function insertAtCursor(textarea, value) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(end);
      textarea.value = `${before}${value}${after}`;
      const newPos = start + value.length;
      textarea.setSelectionRange(newPos, newPos);
      textarea.focus();
    }

    function setupEmojiPicker(root) {
      const textarea = root.querySelector('textarea[name="text"]');
      const panel = root.querySelector('[data-emoji-panel]');
      const grid = root.querySelector('[data-emoji-grid]');
      const toggle = root.querySelector('[data-emoji-toggle]');
      const suggest = root.querySelector('[data-emoji-suggest]');
      const tabs = root.querySelectorAll('[data-emoji-tab]');
      if (!textarea || !panel || !grid || !toggle || !suggest) return;

      function renderGrid(mode) {
        grid.innerHTML = '';
        const items = mode === 'gif'
          ? emojiCatalog.filter((item) => item.url)
          : emojiCatalog;

        if (!items.length) {
          grid.innerHTML = '<div class="text-muted small">Нет GIF-эмодзи</div>';
          return;
        }

        items.forEach((item) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'emoji-btn';
          btn.title = `:${item.code}:`;
          if (mode === 'gif' && item.url) {
            btn.innerHTML = `<img src="${item.url}" alt=":${item.code}:" class="emoji" loading="lazy">`;
          } else {
            btn.textContent = item.char || `:${item.code}:`;
          }
          btn.addEventListener('click', () => insertAtCursor(textarea, `:${item.code}:`));
          grid.appendChild(btn);
        });
      }

      function setTab(active) {
        tabs.forEach((tab) => tab.classList.toggle('is-active', tab.dataset.emojiTab === active));
        renderGrid(active);
      }

      toggle.addEventListener('click', () => {
        panel.hidden = !panel.hidden;
        if (!panel.hidden) {
          setTab(panel.dataset.activeTab || 'emoji');
        }
      });

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          panel.dataset.activeTab = tab.dataset.emojiTab;
          setTab(tab.dataset.emojiTab);
        });
      });

      textarea.addEventListener('input', () => {
        const text = textarea.value.slice(0, textarea.selectionStart);
        const match = text.match(/(^|\s):([a-z0-9_+-]{1,})$/i);
        if (!match) {
          suggest.style.display = 'none';
          return;
        }

        const prefix = match[2].toLowerCase();
        const suggestions = emojiCatalog.filter((item) => item.code.startsWith(prefix)).slice(0, 6);
        if (!suggestions.length) {
          suggest.style.display = 'none';
          return;
        }

        suggest.innerHTML = '';
        suggestions.forEach((item) => {
          const entry = document.createElement('div');
          entry.className = 'emoji-suggest-item';
          entry.textContent = `:${item.code}: ${item.char || ''}`.trim();
          entry.addEventListener('click', () => {
            const before = textarea.value.substring(0, textarea.selectionStart).replace(/(:[a-z0-9_+-]*)$/i, `:${item.code}:`);
            const after = textarea.value.substring(textarea.selectionStart);
            textarea.value = `${before}${after}`;
            textarea.focus();
            suggest.style.display = 'none';
          });
          suggest.appendChild(entry);
        });
        suggest.style.display = 'block';
      });
    }


    setupEmojiPicker(document.getElementById('post-form'));
  </script>

{% else %}
  <div class="alert alert-light border border-muted mt-5 text-center rounded-3 py-4">
    <i class="fas fa-sign-in-alt me-2 text-muted" aria-hidden="true"></i>
    <a href="{% url 'login' %}" class="alert-link">Войдите</a>, чтобы писать сообщения.
  </div>
{% endif %}

<style>
  .hover-underline:hover {
    text-decoration: underline !important;
  }
</style>
  </div>
</div>
{% endblock %}