{% extends 'main/base.html' %}
{% load static %}
{% load emoji_extras %}

{% block title %}{{ thread.title }} ‚Äì –§–æ—Ä—É–º{% endblock %}

{% block content %}
{% emoji_catalog as emoji_catalog %}
<div class="container py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
  <h1 class="mb-0 text-truncate">{{ thread.title|emoji_codes }}</h1>

  <div class="d-flex gap-2">
    {% if user.is_staff %}
    <form method="post" action="{% url 'toggle_pin_thread' thread.id %}" class="d-inline">
      {% csrf_token %}
      <button type="submit" class="btn btn-sm {% if thread.is_pinned %}btn-warning{% else %}btn-outline-secondary{% endif %} rounded-pill px-3" aria-label="Toggle pinned">
        <i class="fas fa-thumbtack me-1" aria-hidden="true"></i>
        {% if thread.is_pinned %}–û—Ç–∫—Ä–µ–ø–∏—Ç—å{% else %}–ó–∞–∫—Ä–µ–ø–∏—Ç—å{% endif %}
      </button>
    </form>
    {% endif %}

    <a href="{% url 'thread_list' thread.subsection.id %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3" aria-label="Back to thread list">
      <i class="fas fa-arrow-left me-1" aria-hidden="true"></i> –ö —Ç–µ–º–∞–º
    </a>
  </div>
</div>

{% for post in posts %}
<div class="card mb-4 shadow-sm">
  <div class="card-body p-4">
    <!-- –ê–≤—Ç–æ—Ä + –∞–≤–∞—Ç–∞—Ä -->
    <div class="d-flex align-items-start mb-3">
      <!-- –ê–≤–∞—Ç–∞—Ä -->
      {% with avatar_url=post.author.profile.avatar_url %}
        <img 
          src="{{ avatar_url }}"
          alt="–ê–≤–∞—Ç–∞—Ä {{ post.author.username }}"
          class="rounded-circle border border-light me-3"
          width="50"
          height="50"
          loading="lazy"
          onerror="this.onerror=null; this.src='{% static "images/default-avatar.png" %}';"
        >
      {% endwith %}

      <!-- –ò–º—è –∏ –¥–∞—Ç–∞ -->
      <div>
        <strong>
          <a href="{% url 'user_profile' post.author.id %}" class="text-decoration-none text-primary hover-underline">
            {{ post.author.username }}
          </a>
        </strong>
        <div class="text-muted small"><time datetime="{{ post.created_at|date:'c' }}">{{ post.created_at|date:"d.m.Y H:i" }}</time></div>
      </div>
    </div>

    <!-- –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ -->
    {% if post.text %}
      <div class="mb-3 fs-6">{{ post.text|emoji_codes }}</div>
    {% endif %}

    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
    {% if post.image %}
      <div class="mt-2">
        <img 
          src="{{ post.image.url }}" 
          alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ –ø–æ—Å—Ç—É"
          class="img-fluid rounded border"
          style="max-height: 600px; object-fit: contain;"
          loading="lazy"
        >
      </div>
    {% endif %}
  </div>

  <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø–æ—Å—Ç) -->
  {% if user.is_authenticated and post.author == user %}
    <div class="card-footer bg-light border-top-0 p-3">
        <a href="{% url 'edit_post' post.id %}" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
        <i class="fas fa-edit me-1" aria-hidden="true"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
      </a>
    </div>
  {% endif %}
</div>
{% endfor %}

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if posts.has_other_pages %}
<nav aria-label="–ü–æ—Å—Ç—ã" class="mt-5">
  <ul class="pagination justify-content-center">
    {% if posts.has_previous %}
      <li class="page-item">
        <a class="page-link rounded-pill" href="?page=1">&laquo; –ø–µ—Ä–≤–∞—è</a>
      </li>
      <li class="page-item">
        <a class="page-link rounded-pill" href="?page={{ posts.previous_page_number }}">–ø—Ä–µ–¥—ã–¥—É—â–∞—è</a>
      </li>
    {% endif %}

    <li class="page-item">
      <span class="page-link bg-light border-0 rounded-pill px-3">
        –°—Ç—Ä. {{ posts.number }} –∏–∑ {{ posts.paginator.num_pages }}
      </span>
    </li>

    {% if posts.has_next %}
      <li class="page-item">
        <a class="page-link rounded-pill" href="?page={{ posts.next_page_number }}">—Å–ª–µ–¥—É—é—â–∞—è</a>
      </li>
      <li class="page-item">
        <a class="page-link rounded-pill" href="?page={{ posts.paginator.num_pages }}">–ø–æ—Å–ª–µ–¥–Ω—è—è &raquo;</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ -->
{% if user.is_authenticated %}
  <div class="card mt-5">
    <div class="card-header bg-light">
      <h5 class="mb-0">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="post-form" action="{% url 'new_post' thread.id %}">
        {% csrf_token %}
        <div class="emoji-toolbar">
          <button type="button" class="emoji-toggle" data-emoji-toggle aria-label="–û—Ç–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏">üòä</button>
        </div>
        <div class="emoji-panel" data-emoji-panel hidden>
          <div class="emoji-tabs">
            <button type="button" class="emoji-tab is-active" data-emoji-tab="emoji">Emoji</button>
            <button type="button" class="emoji-tab" data-emoji-tab="gif">GIF</button>
          </div>
          <div class="emoji-grid" data-emoji-grid></div>
        </div>
        <div class="mb-3">
          <div class="emoji-wrapper">
            <div class="emoji-suggest" data-emoji-suggest></div>
            <textarea 
            name="text" 
            class="form-control" 
            rows="4" 
            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
            required
            ></textarea>
          </div>
        </div>
        <div class="mb-3">
          <label for="image-input" class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="file" name="image" class="form-control" accept="image/*" id="image-input">
          <div class="form-text text-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG, PNG, –¥–æ 5 –ú–ë</div>
          <div id="image-preview" class="mt-2" style="display: none;">
            <img id="preview-img" class="img-thumbnail rounded" style="max-height: 200px; object-fit: contain; border: 1px solid #e9ecef;">
          </div>
        </div>
        <button type="submit" class="btn btn-primary rounded-pill px-4 py-2" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
          <i class="fas fa-paper-plane me-1" aria-hidden="true"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
      </form>
    </div>
  </div>

  {{ emoji_catalog|json_script:"emoji-catalog" }}

  <script>
    const emojiCatalog = JSON.parse(document.getElementById('emoji-catalog').textContent || '[]');

    function insertAtCursor(textarea, value) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(end);
      textarea.value = `${before}${value}${after}`;
      const newPos = start + value.length;
      textarea.setSelectionRange(newPos, newPos);
      textarea.focus();
    }

    function setupEmojiPicker(root) {
      const textarea = root.querySelector('textarea[name="text"]');
      const panel = root.querySelector('[data-emoji-panel]');
      const grid = root.querySelector('[data-emoji-grid]');
      const toggle = root.querySelector('[data-emoji-toggle]');
      const suggest = root.querySelector('[data-emoji-suggest]');
      const tabs = root.querySelectorAll('[data-emoji-tab]');

      if (!textarea || !panel || !grid || !toggle || !suggest) return;

      function renderGrid(mode) {
        grid.innerHTML = '';
        const items = mode === 'gif'
          ? emojiCatalog.filter((item) => item.url)
          : emojiCatalog;

        if (!items.length) {
          grid.innerHTML = '<div class="text-muted small">–ù–µ—Ç GIF-—ç–º–æ–¥–∑–∏</div>';
          return;
        }

        items.forEach((item) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'emoji-btn';
          btn.title = `:${item.code}:`;
          if (mode === 'gif' && item.url) {
            btn.innerHTML = `<img src="${item.url}" alt=":${item.code}:" class="emoji" loading="lazy">`;
          } else {
            btn.textContent = item.char || `:${item.code}:`;
          }
          btn.addEventListener('click', () => insertAtCursor(textarea, `:${item.code}:`));
          grid.appendChild(btn);
        });
      }

      function setTab(active) {
        tabs.forEach((tab) => tab.classList.toggle('is-active', tab.dataset.emojiTab === active));
        renderGrid(active);
      }

      toggle.addEventListener('click', () => {
        panel.hidden = !panel.hidden;
        if (!panel.hidden) {
          setTab(panel.dataset.activeTab || 'emoji');
        }
      });

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          panel.dataset.activeTab = tab.dataset.emojiTab;
          setTab(tab.dataset.emojiTab);
        });
      });

      textarea.addEventListener('input', () => {
        const text = textarea.value.slice(0, textarea.selectionStart);
        const match = text.match(/(^|\s):([a-z0-9_+-]{1,})$/i);
        if (!match) {
          suggest.style.display = 'none';
          return;
        }

        const prefix = match[2].toLowerCase();
        const suggestions = emojiCatalog.filter((item) => item.code.startsWith(prefix)).slice(0, 6);
        if (!suggestions.length) {
          suggest.style.display = 'none';
          return;
        }

        suggest.innerHTML = '';
        suggestions.forEach((item) => {
          const entry = document.createElement('div');
          entry.className = 'emoji-suggest-item';
          entry.textContent = `:${item.code}: ${item.char || ''}`.trim();
          entry.addEventListener('click', () => {
            const before = textarea.value.substring(0, textarea.selectionStart).replace(/(:[a-z0-9_+-]*)$/i, `:${item.code}:`);
            const after = textarea.value.substring(textarea.selectionStart);
            textarea.value = `${before}${after}`;
            textarea.focus();
            suggest.style.display = 'none';
          });
          suggest.appendChild(entry);
        });
        suggest.style.display = 'block';
      });
    }

    document.getElementById('image-input').addEventListener('change', function(e) {
      const preview = document.getElementById('image-preview');
      const img = document.getElementById('preview-img');
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          img.src = event.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = 'none';
      }
    });

    setupEmojiPicker(document.getElementById('post-form'));
  </script>

{% else %}
  <div class="alert alert-light border border-muted mt-5 text-center rounded-3 py-4">
    <i class="fas fa-sign-in-alt me-2 text-muted" aria-hidden="true"></i>
    <a href="{% url 'login' %}" class="alert-link">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.
  </div>
{% endif %}

<style>
  .hover-underline:hover {
    text-decoration: underline !important;
  }
</style>
  </div>
</div>
{% endblock %}