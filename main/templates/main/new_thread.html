{% extends 'main/base.html' %}
{% load emoji_extras %}
{% block title %}Новая тема в {{ subsection.title }} – {{ block.super }}{% endblock %}

{% block content %}
{% emoji_catalog as emoji_catalog %}
<style>
  .tg-compose-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .tg-input-field {
    position: relative;
    flex: 1;
  }

  .tg-input-tools {
    position: absolute;
    right: 12px;
    bottom: 10px;
    display: flex;
    gap: 8px;
  }

  .tg-icon-btn {
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text);
    width: 34px;
    height: 34px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .tg-icon-btn:hover {
    background: rgba(255, 255, 255, 0.08);
  }

  .tg-send-btn {
    background: var(--accent);
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 20px rgba(0, 122, 204, 0.35);
    color: #ffffff;
  }

  .tg-send-btn:hover {
    background: var(--accent-strong);
  }

  .tg-textarea {
    padding-right: 86px;
  }
</style>
<div class="container py-4">
  <div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-header bg-primary bg-gradient text-white rounded-top-3 py-3">
        <h1 class="h5 mb-0 fw-semibold">
          <i class="fas fa-plus-circle me-2" aria-hidden="true"></i>Новая тема в «{{ subsection.title }}"
        </h1>
      </div>
      <div class="card-body p-4">
        <form method="post">
          {% csrf_token %}
          
          <div class="mb-4">
            <label for="id_title" class="form-label fw-medium text-white">Заголовок темы</label>
            <input
              type="text"
              id="id_title"
              name="title"
              class="form-control {% if form.title.errors %}is-invalid{% endif %} rounded-2 py-2"
              maxlength="200"
              required
              autofocus
              placeholder="Кратко и по делу"
            >
            {% if form.title.errors %}
              <div class="invalid-feedback mt-1">{{ form.title.errors|first }}</div>
            {% endif %}
            <div class="form-text text-white small">Макс. 200 символов</div>
          </div>

          <div class="mb-4">
            <label for="id_text" class="form-label fw-medium text-white">Первое сообщение</label>
            <div class="emoji-panel" data-emoji-panel hidden>
              <div class="emoji-tabs">
                <button type="button" class="emoji-tab is-active" data-emoji-tab="emoji">Emoji</button>
                <button type="button" class="emoji-tab" data-emoji-tab="gif">GIF</button>
              </div>
              <div class="emoji-grid" data-emoji-grid></div>
            </div>
            <div class="emoji-wrapper tg-compose-row">
              <div class="tg-input-field">
                <div class="emoji-suggest" data-emoji-suggest></div>
                <textarea
                  id="id_text"
                  name="text"
                  class="form-control tg-textarea {% if form.text.errors %}is-invalid{% endif %} rounded-2"
                  rows="4"
                  required
                  placeholder="Опишите суть темы. Используйте абзацы для лучшей читаемости."
                ></textarea>
                <div class="tg-input-tools">
                  <button type="button" class="tg-icon-btn" data-emoji-toggle aria-label="Открыть эмодзи">
                    <i class="far fa-smile" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
              <button type="submit" class="tg-send-btn" aria-label="Создать тему">
                <i class="fas fa-paper-plane" aria-hidden="true"></i>
              </button>
            </div>
            {% if form.text.errors %}
              <div class="invalid-feedback mt-1">{{ form.text.errors|first }}</div>
            {% endif %}
          </div>

          <div class="d-flex flex-wrap gap-3 pt-2">
            <a href="{% url 'thread_list' subsection.id %}" class="btn btn-outline-secondary rounded-pill px-4 py-2">
              <i class="fas fa-times me-1" aria-hidden="true"></i> Отмена
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  </div>
</div>

{{ emoji_catalog|json_script:"emoji-catalog" }}

<script>
  const emojiCatalog = JSON.parse(document.getElementById('emoji-catalog').textContent || '[]');

  function insertAtCursor(textarea, value) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    textarea.value = `${before}${value}${after}`;
    const newPos = start + value.length;
    textarea.setSelectionRange(newPos, newPos);
    textarea.focus();
  }

  function setupEmojiPicker(root) {
    const textarea = root.querySelector('textarea[name="text"]');
    const panel = root.querySelector('[data-emoji-panel]');
    const grid = root.querySelector('[data-emoji-grid]');
    const toggle = root.querySelector('[data-emoji-toggle]');
    const suggest = root.querySelector('[data-emoji-suggest]');
    const tabs = root.querySelectorAll('[data-emoji-tab]');

    if (!textarea || !panel || !grid || !toggle || !suggest) return;

    function renderGrid(mode) {
      grid.innerHTML = '';
      const items = mode === 'gif'
        ? emojiCatalog.filter((item) => item.url)
        : emojiCatalog;

      if (!items.length) {
        grid.innerHTML = '<div class="text-muted small">Нет GIF-эмодзи</div>';
        return;
      }

      items.forEach((item) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-btn';
        btn.title = `:${item.code}:`;
        if (mode === 'gif' && item.url) {
          btn.innerHTML = `<img src="${item.url}" alt=":${item.code}:" class="emoji" loading="lazy">`;
        } else {
          btn.textContent = item.char || `:${item.code}:`;
        }
        btn.addEventListener('click', () => insertAtCursor(textarea, `:${item.code}:`));
        grid.appendChild(btn);
      });
    }

    function setTab(active) {
      tabs.forEach((tab) => tab.classList.toggle('is-active', tab.dataset.emojiTab === active));
      renderGrid(active);
    }

    toggle.addEventListener('click', () => {
      panel.hidden = !panel.hidden;
      if (!panel.hidden) {
        setTab(panel.dataset.activeTab || 'emoji');
      }
    });

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        panel.dataset.activeTab = tab.dataset.emojiTab;
        setTab(tab.dataset.emojiTab);
      });
    });

    textarea.addEventListener('input', () => {
      const text = textarea.value.slice(0, textarea.selectionStart);
      const match = text.match(/(^|\s):([a-z0-9_+-]{1,})$/i);
      if (!match) {
        suggest.style.display = 'none';
        return;
      }

      const prefix = match[2].toLowerCase();
      const suggestions = emojiCatalog.filter((item) => item.code.startsWith(prefix)).slice(0, 6);
      if (!suggestions.length) {
        suggest.style.display = 'none';
        return;
      }

      suggest.innerHTML = '';
      suggestions.forEach((item) => {
        const entry = document.createElement('div');
        entry.className = 'emoji-suggest-item';
        entry.textContent = `:${item.code}: ${item.char || ''}`.trim();
        entry.addEventListener('click', () => {
          const before = textarea.value.substring(0, textarea.selectionStart).replace(/(:[a-z0-9_+-]*)$/i, `:${item.code}:`);
          const after = textarea.value.substring(textarea.selectionStart);
          textarea.value = `${before}${after}`;
          textarea.focus();
          suggest.style.display = 'none';
        });
        suggest.appendChild(entry);
      });
      suggest.style.display = 'block';
    });
  }

  setupEmojiPicker(document.querySelector('form'));
</script>
{% endblock %}