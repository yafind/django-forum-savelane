{% extends 'main/base.html' %}
{% load emoji_extras %}
{% block title %}–ù–æ–≤–∞—è —Ç–µ–º–∞ –≤ {{ subsection.title }} ‚Äì {{ block.super }}{% endblock %}

{% block content %}
{% emoji_catalog as emoji_catalog %}
<div class="container py-4">
  <div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-header bg-primary bg-gradient text-white rounded-top-3 py-3">
        <h1 class="h5 mb-0 fw-semibold">
          <i class="fas fa-plus-circle me-2" aria-hidden="true"></i>–ù–æ–≤–∞—è —Ç–µ–º–∞ –≤ ¬´{{ subsection.title }}"
        </h1>
      </div>
      <div class="card-body p-4">
        <form method="post">
          {% csrf_token %}
          
          <div class="mb-4">
            <label for="id_title" class="form-label fw-medium">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º—ã</label>
            <input
              type="text"
              id="id_title"
              name="title"
              class="form-control {% if form.title.errors %}is-invalid{% endif %} rounded-2 py-2"
              maxlength="200"
              required
              autofocus
              placeholder="–ö—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É"
            >
            {% if form.title.errors %}
              <div class="invalid-feedback mt-1">{{ form.title.errors|first }}</div>
            {% endif %}
            <div class="form-text text-muted small">–ú–∞–∫—Å. 200 —Å–∏–º–≤–æ–ª–æ–≤</div>
          </div>

          <div class="mb-4">
            <label for="id_text" class="form-label fw-medium">–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
            <div class="emoji-toolbar">
              <button type="button" class="emoji-toggle" data-emoji-toggle aria-label="–û—Ç–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏">üòä</button>
            </div>
            <div class="emoji-panel" data-emoji-panel hidden>
              <div class="emoji-tabs">
                <button type="button" class="emoji-tab is-active" data-emoji-tab="emoji">Emoji</button>
                <button type="button" class="emoji-tab" data-emoji-tab="gif">GIF</button>
              </div>
              <div class="emoji-grid" data-emoji-grid></div>
            </div>
            <div class="emoji-wrapper">
              <div class="emoji-suggest" data-emoji-suggest></div>
            <textarea
              id="id_text"
              name="text"
              class="form-control {% if form.text.errors %}is-invalid{% endif %} rounded-2"
              rows="6"
              required
              placeholder="–û–ø–∏—à–∏—Ç–µ —Å—É—Ç—å —Ç–µ–º—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–±–∑–∞—Ü—ã –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏."
              ></textarea>
            </div>
            {% if form.text.errors %}
              <div class="invalid-feedback mt-1">{{ form.text.errors|first }}</div>
            {% endif %}
          </div>

          <div class="d-flex flex-wrap gap-3 pt-2">
            <button type="submit" class="btn btn-success rounded-pill px-4 py-2">
              <i class="fas fa-paper-plane me-1" aria-hidden="true"></i> –°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É
            </button>
            <a href="{% url 'thread_list' subsection.id %}" class="btn btn-outline-secondary rounded-pill px-4 py-2">
              <i class="fas fa-times me-1" aria-hidden="true"></i> –û—Ç–º–µ–Ω–∞
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  </div>
</div>

{{ emoji_catalog|json_script:"emoji-catalog" }}

<script>
  const emojiCatalog = JSON.parse(document.getElementById('emoji-catalog').textContent || '[]');

  function insertAtCursor(textarea, value) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    textarea.value = `${before}${value}${after}`;
    const newPos = start + value.length;
    textarea.setSelectionRange(newPos, newPos);
    textarea.focus();
  }

  function setupEmojiPicker(root) {
    const textarea = root.querySelector('textarea[name="text"]');
    const panel = root.querySelector('[data-emoji-panel]');
    const grid = root.querySelector('[data-emoji-grid]');
    const toggle = root.querySelector('[data-emoji-toggle]');
    const suggest = root.querySelector('[data-emoji-suggest]');
    const tabs = root.querySelectorAll('[data-emoji-tab]');

    if (!textarea || !panel || !grid || !toggle || !suggest) return;

    function renderGrid(mode) {
      grid.innerHTML = '';
      const items = mode === 'gif'
        ? emojiCatalog.filter((item) => item.url)
        : emojiCatalog;

      if (!items.length) {
        grid.innerHTML = '<div class="text-muted small">–ù–µ—Ç GIF-—ç–º–æ–¥–∑–∏</div>';
        return;
      }

      items.forEach((item) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-btn';
        btn.title = `:${item.code}:`;
        if (mode === 'gif' && item.url) {
          btn.innerHTML = `<img src="${item.url}" alt=":${item.code}:" class="emoji" loading="lazy">`;
        } else {
          btn.textContent = item.char || `:${item.code}:`;
        }
        btn.addEventListener('click', () => insertAtCursor(textarea, `:${item.code}:`));
        grid.appendChild(btn);
      });
    }

    function setTab(active) {
      tabs.forEach((tab) => tab.classList.toggle('is-active', tab.dataset.emojiTab === active));
      renderGrid(active);
    }

    toggle.addEventListener('click', () => {
      panel.hidden = !panel.hidden;
      if (!panel.hidden) {
        setTab(panel.dataset.activeTab || 'emoji');
      }
    });

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        panel.dataset.activeTab = tab.dataset.emojiTab;
        setTab(tab.dataset.emojiTab);
      });
    });

    textarea.addEventListener('input', () => {
      const text = textarea.value.slice(0, textarea.selectionStart);
      const match = text.match(/(^|\s):([a-z0-9_+-]{1,})$/i);
      if (!match) {
        suggest.style.display = 'none';
        return;
      }

      const prefix = match[2].toLowerCase();
      const suggestions = emojiCatalog.filter((item) => item.code.startsWith(prefix)).slice(0, 6);
      if (!suggestions.length) {
        suggest.style.display = 'none';
        return;
      }

      suggest.innerHTML = '';
      suggestions.forEach((item) => {
        const entry = document.createElement('div');
        entry.className = 'emoji-suggest-item';
        entry.textContent = `:${item.code}: ${item.char || ''}`.trim();
        entry.addEventListener('click', () => {
          const before = textarea.value.substring(0, textarea.selectionStart).replace(/(:[a-z0-9_+-]*)$/i, `:${item.code}:`);
          const after = textarea.value.substring(textarea.selectionStart);
          textarea.value = `${before}${after}`;
          textarea.focus();
          suggest.style.display = 'none';
        });
        suggest.appendChild(entry);
      });
      suggest.style.display = 'block';
    });
  }

  setupEmojiPicker(document.querySelector('form'));
</script>
{% endblock %}