{% extends 'main/base.html' %}
{% load static %}
{% load emoji_extras %}

{% block title %}Диалог с {{ other_user.username }} – {{ block.super }}{% endblock %}

{% block content %}
{% emoji_catalog as emoji_catalog %}
<style>
  .tg-chat {
    font-family: "Manrope", "Segoe UI", sans-serif;
    background:
      radial-gradient(circle at 12% 18%, rgba(0, 122, 204, 0.12), transparent 45%),
      radial-gradient(circle at 85% 12%, rgba(255, 143, 31, 0.12), transparent 40%),
      var(--bg);
    min-height: calc(100vh - 64px);
    padding: 20px 0 40px;
  }

  .tg-chat-shell {
    max-width: 1180px;
    margin: 0 auto;
    background: var(--surface);
    border-radius: 20px;
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    border: 1px solid var(--border);
    overflow: hidden;
    display: grid;
    grid-template-columns: minmax(280px, 360px) 1fr;
    min-height: 72vh;
  }

  .tg-sidebar {
    background: var(--surface-2);
    border-right: 1px solid var(--border);
    padding: 18px 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .tg-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0;
    color: var(--text);
  }

  .tg-search {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface-3);
    border: 1px solid var(--border);
    padding: 10px 12px;
    border-radius: 12px;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
  }

  .tg-search input {
    border: none;
    outline: none;
    width: 100%;
    font-size: 0.95rem;
    background: transparent;
    color: var(--text);
  }

  .tg-list {
    display: grid;
    gap: 10px;
    overflow-y: auto;
    padding-right: 6px;
  }

  .tg-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: var(--surface);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .tg-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 18px rgba(0, 0, 0, 0.35);
  }

  .tg-item.is-active {
    border-color: rgba(0, 122, 204, 0.55);
    box-shadow: 0 12px 20px rgba(0, 122, 204, 0.25);
    background: linear-gradient(135deg, rgba(0, 122, 204, 0.18), rgba(31, 143, 255, 0.08));
  }

  .tg-item-name {
    font-weight: 700;
    color: var(--text);
  }

  .tg-item-meta {
    font-size: 0.78rem;
    color: var(--muted);
  }

  .tg-item-text {
    font-size: 0.88rem;
    color: var(--muted);
  }

  .tg-chat a {
    color: var(--text);
  }

  .tg-chat a:hover {
    color: var(--accent-strong) !important;
  }

  .tg-badge {
    background: var(--accent);
    color: #ffffff;
    font-size: 0.75rem;
    min-width: 22px;
    height: 22px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 6px;
  }

  .tg-chat-panel {
    display: flex;
    flex-direction: column;
  }

  .tg-chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  .tg-chat-title {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .tg-chat-title h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    color: var(--text);
  }

  .tg-chat-body {
    padding: 22px 20px;
    background-image:
      radial-gradient(circle at 10% 20%, rgba(0, 122, 204, 0.12), transparent 45%),
      radial-gradient(circle at 90% 10%, rgba(255, 143, 31, 0.1), transparent 40%);
    flex: 1;
    overflow-y: auto;
    color: var(--text);
  }

  .tg-message {
    display: flex;
    margin-bottom: 14px;
  }

  .tg-message.is-me {
    justify-content: flex-end;
  }

  .tg-bubble {
    max-width: 70%;
    padding: 12px 14px;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
    position: relative;
  }

  .tg-bubble.is-me {
    background: linear-gradient(135deg, #007acc, #1f8fff);
    color: #ffffff;
    border-top-right-radius: 6px;
  }

  .tg-bubble.is-them {
    background: var(--surface-2);
    border: 1px solid var(--border);
    color: var(--text);
    border-top-left-radius: 6px;
  }

  .tg-meta {
    font-size: 0.75rem;
    margin-bottom: 6px;
    color: rgba(255, 255, 255, 0.75);
  }

  .tg-meta.is-them {
    color: var(--muted);
  }

  .tg-typing {
    font-size: 0.8rem;
    color: var(--muted);
  }

  .tg-composer {
    padding: 16px 20px 20px;
    border-top: 1px solid var(--border);
    background: var(--surface-2);
  }

  .tg-input {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .tg-input textarea {
    resize: none;
    border-radius: 16px;
    border: 1px solid var(--border);
    padding: 12px 14px;
    background: var(--surface-3);
    color: var(--text);
  }

  .tg-send {
    background: var(--accent);
    color: #ffffff;
    border: none;
    border-radius: 50%;
    width: 46px;
    height: 46px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    box-shadow: 0 10px 20px rgba(0, 122, 204, 0.35);
  }

  .tg-send:hover {
    background: var(--accent-strong);
  }

  @media (max-width: 992px) {
    .tg-chat-shell {
      grid-template-columns: 1fr;
      border-radius: 0;
      min-height: calc(100vh - 64px);
    }

    .tg-sidebar {
      border-right: none;
      border-bottom: 1px solid rgba(60, 80, 120, 0.08);
    }

    .tg-bubble {
      max-width: 85%;
    }
  }
</style>

<div class="tg-chat">
  <div class="tg-chat-shell">
    <aside class="tg-sidebar">
      <h2 class="tg-title">Сообщения</h2>
      <div class="tg-search">
        <i class="fas fa-search text-muted" aria-hidden="true"></i>
        <input type="text" placeholder="Поиск по диалогам" aria-label="Поиск по диалогам">
      </div>

      {% if conversation_items %}
        <div class="tg-list" data-conversation-list>
          {% for item in conversation_items %}
            <a href="{% url 'message_detail' item.conversation.id %}" class="tg-item text-reset {% if item.conversation.id == conversation.id %}is-active{% endif %}">
              <img
                src="{{ item.other_user.profile.avatar_url }}"
                alt="Аватар {{ item.other_user.username }}"
                class="rounded-circle border"
                width="46"
                height="46"
                loading="lazy"
                onerror="this.onerror=null; this.src='{% static "images/default-avatar.png" %}';"
              >
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="tg-item-name">{{ item.other_user.username }}</div>
                  {% if item.last_message %}
                    <div class="tg-item-meta">{{ item.last_message.created_at|date:"d.m.Y H:i" }}</div>
                  {% endif %}
                </div>
                {% if item.last_message %}
                  <div class="tg-item-text text-truncate">
                    {% if item.is_typing %}печатает…{% else %}{{ item.last_message.body|emoji_codes }}{% endif %}
                  </div>
                {% else %}
                  <div class="tg-item-text">{% if item.is_typing %}печатает…{% else %}Нет сообщений{% endif %}</div>
                {% endif %}
              </div>
              {% if item.unread_count %}
                <span class="tg-badge">{{ item.unread_count }}</span>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">Пока нет диалогов.</div>
      {% endif %}
    </aside>

    <section class="tg-chat-panel">
      <div class="tg-chat-header">
        <div class="tg-chat-title">
          <img
            src="{{ other_user.profile.avatar_url }}"
            alt="Аватар {{ other_user.username }}"
            class="rounded-circle border"
            width="44"
            height="44"
            loading="lazy"
            onerror="this.onerror=null; this.src='{% static "images/default-avatar.png" %}';"
          >
          <div>
            <h1>{{ other_user.username }}</h1>
            <div class="tg-typing" id="typing-indicator">{% if typing_active %}печатает…{% endif %}</div>
            <a href="{% url 'user_profile' other_user.id %}" class="text-muted small">Профиль пользователя</a>
          </div>
        </div>
        <a href="{% url 'messages_list' %}" class="btn btn-outline-secondary btn-sm">Назад</a>
      </div>

      <div class="tg-chat-body" data-message-list>
        {% if message_list %}
          {% for msg in message_list %}
            <div class="tg-message {% if msg.sender_id == user.id %}is-me{% endif %}" data-message-id="{{ msg.id }}">
              <div class="tg-bubble {% if msg.sender_id == user.id %}is-me{% else %}is-them{% endif %}">
                <div class="tg-meta {% if msg.sender_id == user.id %}{% else %}is-them{% endif %}">
                  {{ msg.sender.username }} • {{ msg.created_at|date:"d.m.Y H:i" }}
                </div>
                <div style="white-space: pre-wrap;">{{ msg.body|emoji_codes }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="text-muted">Сообщений нет. Напишите первым.</div>
        {% endif %}
      </div>

      <div class="tg-composer">
        <form method="post" aria-label="Форма личного сообщения">
          {% csrf_token %}
          <div class="emoji-panel" data-emoji-panel hidden>
            <div class="emoji-tabs">
              <button type="button" class="emoji-tab is-active" data-emoji-tab="emoji">Emoji</button>
              <button type="button" class="emoji-tab" data-emoji-tab="gif">GIF</button>
            </div>
            <div class="emoji-grid" data-emoji-grid></div>
          </div>
          <div class="tg-input emoji-wrapper">
            <div class="tg-input-field">
              <div class="emoji-suggest" data-emoji-suggest></div>
              <textarea name="body" class="form-control" rows="2" placeholder="Напишите сообщение..." required></textarea>
              <div class="tg-input-tools">
                <button type="button" class="tg-icon-btn" data-emoji-toggle aria-label="Открыть эмодзи">
                  <i class="far fa-smile" aria-hidden="true"></i>
                </button>
              </div>
            </div>
            <button type="submit" class="tg-send" aria-label="Отправить">
              <i class="fas fa-paper-plane" aria-hidden="true"></i>
            </button>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>

{{ emoji_catalog|json_script:"emoji-catalog" }}

<script>
  const convoList = document.querySelector('[data-conversation-list]');
  const messageList = document.querySelector('[data-message-list]');
  const typingIndicator = document.getElementById('typing-indicator');
  const conversationId = {{ conversation.id }};
  const emojiCatalog = JSON.parse(document.getElementById('emoji-catalog').textContent || '[]');

  function insertAtCursor(textarea, value) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    textarea.value = `${before}${value}${after}`;
    const newPos = start + value.length;
    textarea.setSelectionRange(newPos, newPos);
    textarea.focus();
  }

  function setupEmojiPicker(root) {
    const textarea = root.querySelector('textarea[name="body"]');
    const panel = root.querySelector('[data-emoji-panel]');
    const grid = root.querySelector('[data-emoji-grid]');
    const toggle = root.querySelector('[data-emoji-toggle]');
    const suggest = root.querySelector('[data-emoji-suggest]');
    const tabs = root.querySelectorAll('[data-emoji-tab]');

    if (!textarea || !panel || !grid || !toggle || !suggest) return;

    function renderGrid(mode) {
      grid.innerHTML = '';
      const items = mode === 'gif'
        ? emojiCatalog.filter((item) => item.url)
        : emojiCatalog;

      if (!items.length) {
        grid.innerHTML = '<div class="text-muted small">Нет GIF-эмодзи</div>';
        return;
      }

      items.forEach((item) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-btn';
        btn.title = `:${item.code}:`;
        if (mode === 'gif' && item.url) {
          btn.innerHTML = `<img src="${item.url}" alt=":${item.code}:" class="emoji" loading="lazy">`;
        } else {
          btn.textContent = item.char || `:${item.code}:`;
        }
        btn.addEventListener('click', () => insertAtCursor(textarea, `:${item.code}:`));
        grid.appendChild(btn);
      });
    }

    function setTab(active) {
      tabs.forEach((tab) => tab.classList.toggle('is-active', tab.dataset.emojiTab === active));
      renderGrid(active);
    }

    toggle.addEventListener('click', () => {
      panel.hidden = !panel.hidden;
      if (!panel.hidden) {
        setTab(panel.dataset.activeTab || 'emoji');
      }
    });

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        panel.dataset.activeTab = tab.dataset.emojiTab;
        setTab(tab.dataset.emojiTab);
      });
    });

    textarea.addEventListener('input', () => {
      const text = textarea.value.slice(0, textarea.selectionStart);
      const match = text.match(/(^|\s):([a-z0-9_+-]{1,})$/i);
      if (!match) {
        suggest.style.display = 'none';
        return;
      }

      const prefix = match[2].toLowerCase();
      const suggestions = emojiCatalog.filter((item) => item.code.startsWith(prefix)).slice(0, 6);
      if (!suggestions.length) {
        suggest.style.display = 'none';
        return;
      }

      suggest.innerHTML = '';
      suggestions.forEach((item) => {
        const entry = document.createElement('div');
        entry.className = 'emoji-suggest-item';
        entry.textContent = `:${item.code}: ${item.char || ''}`.trim();
        entry.addEventListener('click', () => {
          const before = textarea.value.substring(0, textarea.selectionStart).replace(/(:[a-z0-9_+-]*)$/i, `:${item.code}:`);
          const after = textarea.value.substring(textarea.selectionStart);
          textarea.value = `${before}${after}`;
          textarea.focus();
          suggest.style.display = 'none';
        });
        suggest.appendChild(entry);
      });
      suggest.style.display = 'block';
    });
  }

  function getCsrfToken() {
    const value = `; ${document.cookie}`;
    const parts = value.split('; csrftoken=');
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  function renderConversations(items) {
    if (!convoList) return;
    convoList.innerHTML = '';
    items.forEach((item) => {
      const typingText = item.is_typing ? 'печатает…' : (item.last_message.body_html || 'Нет сообщений');
      const timeText = item.last_message.created_at
        ? new Date(item.last_message.created_at).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
        : '';
      const isActive = item.conversation_id === conversationId;

      const link = document.createElement('a');
      link.href = `/messages/${item.conversation_id}/`;
      link.className = `tg-item text-reset ${isActive ? 'is-active' : ''}`;
      link.innerHTML = `
        <img
          src="${item.other_user.avatar_url}"
          alt="Аватар ${item.other_user.username}"
          class="rounded-circle border"
          width="46"
          height="46"
          loading="lazy"
          onerror="this.onerror=null; this.src='/static/images/default-avatar.png';"
        >
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-center">
            <div class="tg-item-name">${item.other_user.username}</div>
            <div class="tg-item-meta">${timeText}</div>
          </div>
          <div class="tg-item-text text-truncate">${typingText}</div>
        </div>
        ${item.unread_count ? `<span class="tg-badge">${item.unread_count}</span>` : ''}
      `;
      convoList.appendChild(link);
    });
  }

  function appendMessage(msg) {
    const wrapper = document.createElement('div');
    wrapper.className = `tg-message ${msg.sender_id === {{ user.id }} ? 'is-me' : ''}`;
    wrapper.dataset.messageId = msg.id;

    const bubble = document.createElement('div');
    bubble.className = `tg-bubble ${msg.sender_id === {{ user.id }} ? 'is-me' : 'is-them'}`;

    const meta = document.createElement('div');
    meta.className = `tg-meta ${msg.sender_id === {{ user.id }} ? '' : 'is-them'}`;
    meta.textContent = `${msg.sender_name} • ${new Date(msg.created_at).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`;

    const body = document.createElement('div');
    body.style.whiteSpace = 'pre-wrap';
    body.innerHTML = msg.body_html || msg.body;

    bubble.appendChild(meta);
    bubble.appendChild(body);
    wrapper.appendChild(bubble);
    messageList.appendChild(wrapper);
  }

  function getLastMessageId() {
    const messages = messageList.querySelectorAll('[data-message-id]');
    if (!messages.length) return 0;
    return parseInt(messages[messages.length - 1].dataset.messageId, 10);
  }

  async function pollConversationList() {
    try {
      const response = await fetch('{% url "messages_poll" %}', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!response.ok) return;
      const data = await response.json();
      renderConversations(data.items || []);
    } catch (err) {
      return;
    }
  }

  async function pollMessages() {
    const lastId = getLastMessageId();
    try {
      const response = await fetch(`/messages/${conversationId}/poll/?after=${lastId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!response.ok) return;
      const data = await response.json();
      (data.messages || []).forEach(appendMessage);
      if (typeof data.typing_active !== 'undefined' && typingIndicator) {
        typingIndicator.textContent = data.typing_active ? 'печатает…' : '';
      }
      if (data.messages && data.messages.length) {
        messageList.scrollTop = messageList.scrollHeight;
      }
    } catch (err) {
      return;
    }
  }

  async function sendTypingPing() {
    try {
      await fetch(`/messages/${conversationId}/typing/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCsrfToken(),
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
    } catch (err) {
      return;
    }
  }

  let typingTimeout = null;
  const textarea = document.querySelector('textarea[name="body"]');
  if (textarea) {
    textarea.addEventListener('input', () => {
      if (typingTimeout) return;
      typingTimeout = setTimeout(() => { typingTimeout = null; }, 1500);
      sendTypingPing();
    });
  }

  setupEmojiPicker(document.querySelector('.tg-composer'));

  setInterval(pollConversationList, 12000);
  setInterval(pollMessages, 3000);
</script>
{% endblock %}
