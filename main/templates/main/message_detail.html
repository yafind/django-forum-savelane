{% extends 'main/base.html' %}
{% load static %}
{% load emoji_extras %}

{% block title %}–î–∏–∞–ª–æ–≥ —Å {{ other_user.username }} ‚Äì {{ block.super }}{% endblock %}

{% block content %}
{% emoji_catalog as emoji_catalog %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap');

  .tg-chat {
    font-family: "Manrope", "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #eaf2ff 0%, #f7f9fc 40%, #e9f7f1 100%);
    min-height: calc(100vh - 64px);
    padding: 20px 0 40px;
  }

  .tg-chat-shell {
    max-width: 1180px;
    margin: 0 auto;
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 18px 40px rgba(35, 45, 80, 0.12);
    border: 1px solid rgba(60, 80, 120, 0.08);
    overflow: hidden;
    display: grid;
    grid-template-columns: minmax(280px, 360px) 1fr;
    min-height: 72vh;
  }

  .tg-sidebar {
    background: #f8f9fc;
    border-right: 1px solid rgba(60, 80, 120, 0.08);
    padding: 18px 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .tg-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0;
    color: #1f2a44;
  }

  .tg-search {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #ffffff;
    border: 1px solid rgba(40, 60, 100, 0.12);
    padding: 10px 12px;
    border-radius: 12px;
    box-shadow: inset 0 1px 2px rgba(20, 30, 50, 0.05);
  }

  .tg-search input {
    border: none;
    outline: none;
    width: 100%;
    font-size: 0.95rem;
    background: transparent;
  }

  .tg-list {
    display: grid;
    gap: 10px;
    overflow-y: auto;
    padding-right: 6px;
  }

  .tg-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(60, 80, 120, 0.08);
    background: #ffffff;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .tg-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 18px rgba(40, 60, 100, 0.12);
  }

  .tg-item.is-active {
    border-color: rgba(43, 110, 246, 0.45);
    box-shadow: 0 12px 20px rgba(43, 110, 246, 0.15);
    background: linear-gradient(135deg, rgba(43, 110, 246, 0.08), rgba(79, 140, 255, 0.05));
  }

  .tg-item-name {
    font-weight: 700;
    color: #1f2a44;
  }

  .tg-item-meta {
    font-size: 0.78rem;
    color: #7a879b;
  }

  .tg-item-text {
    font-size: 0.88rem;
    color: #4f5d75;
  }

  .tg-badge {
    background: #2b6ef6;
    color: #ffffff;
    font-size: 0.75rem;
    min-width: 22px;
    height: 22px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 6px;
  }

  .tg-chat-panel {
    display: flex;
    flex-direction: column;
  }

  .tg-chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: #ffffff;
    border-bottom: 1px solid rgba(60, 80, 120, 0.08);
  }

  .tg-chat-title {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .tg-chat-title h1 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    color: #1f2a44;
  }

  .tg-chat-body {
    padding: 22px 20px;
    background-image:
      radial-gradient(circle at 10% 20%, rgba(44, 110, 246, 0.08), transparent 45%),
      radial-gradient(circle at 90% 10%, rgba(46, 196, 182, 0.1), transparent 40%);
    flex: 1;
    overflow-y: auto;
  }

  .tg-message {
    display: flex;
    margin-bottom: 14px;
  }

  .tg-message.is-me {
    justify-content: flex-end;
  }

  .tg-bubble {
    max-width: 70%;
    padding: 12px 14px;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(20, 30, 60, 0.08);
    position: relative;
  }

  .tg-bubble.is-me {
    background: linear-gradient(135deg, #2b6ef6, #4f8cff);
    color: #ffffff;
    border-top-right-radius: 6px;
  }

  .tg-bubble.is-them {
    background: #ffffff;
    border: 1px solid rgba(60, 80, 120, 0.12);
    color: #1f2a44;
    border-top-left-radius: 6px;
  }

  .tg-meta {
    font-size: 0.75rem;
    margin-bottom: 6px;
    color: rgba(255, 255, 255, 0.75);
  }

  .tg-meta.is-them {
    color: #7a879b;
  }

  .tg-typing {
    font-size: 0.8rem;
    color: #5a6b84;
  }

  .tg-composer {
    padding: 16px 20px 20px;
    border-top: 1px solid rgba(60, 80, 120, 0.08);
    background: #f8f9fc;
  }

  .tg-input {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .tg-input textarea {
    resize: none;
    border-radius: 14px;
    border: 1px solid rgba(60, 80, 120, 0.15);
    padding: 12px 14px;
  }

  .tg-send {
    background: #2b6ef6;
    color: #ffffff;
    border: none;
    border-radius: 12px;
    padding: 10px 18px;
    font-weight: 600;
  }

  @media (max-width: 992px) {
    .tg-chat-shell {
      grid-template-columns: 1fr;
      border-radius: 0;
      min-height: calc(100vh - 64px);
    }

    .tg-sidebar {
      border-right: none;
      border-bottom: 1px solid rgba(60, 80, 120, 0.08);
    }

    .tg-bubble {
      max-width: 85%;
    }
  }
</style>

<div class="tg-chat">
  <div class="tg-chat-shell">
    <aside class="tg-sidebar">
      <h2 class="tg-title">–°–æ–æ–±—â–µ–Ω–∏—è</h2>
      <div class="tg-search">
        <i class="fas fa-search text-muted" aria-hidden="true"></i>
        <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –¥–∏–∞–ª–æ–≥–∞–º" aria-label="–ü–æ–∏—Å–∫ –ø–æ –¥–∏–∞–ª–æ–≥–∞–º">
      </div>

      {% if conversation_items %}
        <div class="tg-list" data-conversation-list>
          {% for item in conversation_items %}
            <a href="{% url 'message_detail' item.conversation.id %}" class="tg-item text-reset {% if item.conversation.id == conversation.id %}is-active{% endif %}">
              <img
                src="{{ item.other_user.profile.avatar_url }}"
                alt="–ê–≤–∞—Ç–∞—Ä {{ item.other_user.username }}"
                class="rounded-circle border"
                width="46"
                height="46"
                loading="lazy"
                onerror="this.onerror=null; this.src='{% static "images/default-avatar.png" %}';"
              >
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="tg-item-name">{{ item.other_user.username }}</div>
                  {% if item.last_message %}
                    <div class="tg-item-meta">{{ item.last_message.created_at|date:"d.m.Y H:i" }}</div>
                  {% endif %}
                </div>
                {% if item.last_message %}
                  <div class="tg-item-text text-truncate">
                    {% if item.is_typing %}–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶{% else %}{{ item.last_message.body|emoji_codes }}{% endif %}
                  </div>
                {% else %}
                  <div class="tg-item-text">{% if item.is_typing %}–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶{% else %}–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π{% endif %}</div>
                {% endif %}
              </div>
              {% if item.unread_count %}
                <span class="tg-badge">{{ item.unread_count }}</span>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤.</div>
      {% endif %}
    </aside>

    <section class="tg-chat-panel">
      <div class="tg-chat-header">
        <div class="tg-chat-title">
          <img
            src="{{ other_user.profile.avatar_url }}"
            alt="–ê–≤–∞—Ç–∞—Ä {{ other_user.username }}"
            class="rounded-circle border"
            width="44"
            height="44"
            loading="lazy"
            onerror="this.onerror=null; this.src='{% static "images/default-avatar.png" %}';"
          >
          <div>
            <h1>{{ other_user.username }}</h1>
            <div class="tg-typing" id="typing-indicator">{% if typing_active %}–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶{% endif %}</div>
            <a href="{% url 'user_profile' other_user.id %}" class="text-muted small">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
          </div>
        </div>
        <a href="{% url 'messages_list' %}" class="btn btn-outline-secondary btn-sm">–ù–∞–∑–∞–¥</a>
      </div>

      <div class="tg-chat-body" data-message-list>
        {% if message_list %}
          {% for msg in message_list %}
            <div class="tg-message {% if msg.sender_id == user.id %}is-me{% endif %}" data-message-id="{{ msg.id }}">
              <div class="tg-bubble {% if msg.sender_id == user.id %}is-me{% else %}is-them{% endif %}">
                <div class="tg-meta {% if msg.sender_id == user.id %}{% else %}is-them{% endif %}">
                  {{ msg.sender.username }} ‚Ä¢ {{ msg.created_at|date:"d.m.Y H:i" }}
                </div>
                <div style="white-space: pre-wrap;">{{ msg.body|emoji_codes }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="text-muted">–°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—ã–º.</div>
        {% endif %}
      </div>

      <div class="tg-composer">
        <form method="post" aria-label="–§–æ—Ä–º–∞ –ª–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è">
          {% csrf_token %}
          <div class="emoji-toolbar">
            <button type="button" class="emoji-toggle" data-emoji-toggle aria-label="–û—Ç–∫—Ä—ã—Ç—å —ç–º–æ–¥–∑–∏">üòä</button>
          </div>
          <div class="emoji-panel" data-emoji-panel hidden>
            <div class="emoji-tabs">
              <button type="button" class="emoji-tab is-active" data-emoji-tab="emoji">Emoji</button>
              <button type="button" class="emoji-tab" data-emoji-tab="gif">GIF</button>
            </div>
            <div class="emoji-grid" data-emoji-grid></div>
          </div>
          <div class="tg-input emoji-wrapper">
            <div class="emoji-suggest" data-emoji-suggest></div>
            <textarea name="body" class="form-control" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
            <button type="submit" class="tg-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </section>
  </div>
</div>

{{ emoji_catalog|json_script:"emoji-catalog" }}

<script>
  const convoList = document.querySelector('[data-conversation-list]');
  const messageList = document.querySelector('[data-message-list]');
  const typingIndicator = document.getElementById('typing-indicator');
  const conversationId = {{ conversation.id }};
  const emojiCatalog = JSON.parse(document.getElementById('emoji-catalog').textContent || '[]');

  function insertAtCursor(textarea, value) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    textarea.value = `${before}${value}${after}`;
    const newPos = start + value.length;
    textarea.setSelectionRange(newPos, newPos);
    textarea.focus();
  }

  function setupEmojiPicker(root) {
    const textarea = root.querySelector('textarea[name="body"]');
    const panel = root.querySelector('[data-emoji-panel]');
    const grid = root.querySelector('[data-emoji-grid]');
    const toggle = root.querySelector('[data-emoji-toggle]');
    const suggest = root.querySelector('[data-emoji-suggest]');
    const tabs = root.querySelectorAll('[data-emoji-tab]');

    if (!textarea || !panel || !grid || !toggle || !suggest) return;

    function renderGrid(mode) {
      grid.innerHTML = '';
      const items = mode === 'gif'
        ? emojiCatalog.filter((item) => item.url)
        : emojiCatalog;

      if (!items.length) {
        grid.innerHTML = '<div class="text-muted small">–ù–µ—Ç GIF-—ç–º–æ–¥–∑–∏</div>';
        return;
      }

      items.forEach((item) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'emoji-btn';
        btn.title = `:${item.code}:`;
        if (mode === 'gif' && item.url) {
          btn.innerHTML = `<img src="${item.url}" alt=":${item.code}:" class="emoji" loading="lazy">`;
        } else {
          btn.textContent = item.char || `:${item.code}:`;
        }
        btn.addEventListener('click', () => insertAtCursor(textarea, `:${item.code}:`));
        grid.appendChild(btn);
      });
    }

    function setTab(active) {
      tabs.forEach((tab) => tab.classList.toggle('is-active', tab.dataset.emojiTab === active));
      renderGrid(active);
    }

    toggle.addEventListener('click', () => {
      panel.hidden = !panel.hidden;
      if (!panel.hidden) {
        setTab(panel.dataset.activeTab || 'emoji');
      }
    });

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        panel.dataset.activeTab = tab.dataset.emojiTab;
        setTab(tab.dataset.emojiTab);
      });
    });

    textarea.addEventListener('input', () => {
      const text = textarea.value.slice(0, textarea.selectionStart);
      const match = text.match(/(^|\s):([a-z0-9_+-]{1,})$/i);
      if (!match) {
        suggest.style.display = 'none';
        return;
      }

      const prefix = match[2].toLowerCase();
      const suggestions = emojiCatalog.filter((item) => item.code.startsWith(prefix)).slice(0, 6);
      if (!suggestions.length) {
        suggest.style.display = 'none';
        return;
      }

      suggest.innerHTML = '';
      suggestions.forEach((item) => {
        const entry = document.createElement('div');
        entry.className = 'emoji-suggest-item';
        entry.textContent = `:${item.code}: ${item.char || ''}`.trim();
        entry.addEventListener('click', () => {
          const before = textarea.value.substring(0, textarea.selectionStart).replace(/(:[a-z0-9_+-]*)$/i, `:${item.code}:`);
          const after = textarea.value.substring(textarea.selectionStart);
          textarea.value = `${before}${after}`;
          textarea.focus();
          suggest.style.display = 'none';
        });
        suggest.appendChild(entry);
      });
      suggest.style.display = 'block';
    });
  }

  function getCsrfToken() {
    const value = `; ${document.cookie}`;
    const parts = value.split('; csrftoken=');
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  function renderConversations(items) {
    if (!convoList) return;
    convoList.innerHTML = '';
    items.forEach((item) => {
      const typingText = item.is_typing ? '–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶' : (item.last_message.body_html || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π');
      const timeText = item.last_message.created_at
        ? new Date(item.last_message.created_at).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
        : '';
      const isActive = item.conversation_id === conversationId;

      const link = document.createElement('a');
      link.href = `/messages/${item.conversation_id}/`;
      link.className = `tg-item text-reset ${isActive ? 'is-active' : ''}`;
      link.innerHTML = `
        <img
          src="${item.other_user.avatar_url}"
          alt="–ê–≤–∞—Ç–∞—Ä ${item.other_user.username}"
          class="rounded-circle border"
          width="46"
          height="46"
          loading="lazy"
          onerror="this.onerror=null; this.src='/static/images/default-avatar.png';"
        >
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-center">
            <div class="tg-item-name">${item.other_user.username}</div>
            <div class="tg-item-meta">${timeText}</div>
          </div>
          <div class="tg-item-text text-truncate">${typingText}</div>
        </div>
        ${item.unread_count ? `<span class="tg-badge">${item.unread_count}</span>` : ''}
      `;
      convoList.appendChild(link);
    });
  }

  function appendMessage(msg) {
    const wrapper = document.createElement('div');
    wrapper.className = `tg-message ${msg.sender_id === {{ user.id }} ? 'is-me' : ''}`;
    wrapper.dataset.messageId = msg.id;

    const bubble = document.createElement('div');
    bubble.className = `tg-bubble ${msg.sender_id === {{ user.id }} ? 'is-me' : 'is-them'}`;

    const meta = document.createElement('div');
    meta.className = `tg-meta ${msg.sender_id === {{ user.id }} ? '' : 'is-them'}`;
    meta.textContent = `${msg.sender_name} ‚Ä¢ ${new Date(msg.created_at).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`;

    const body = document.createElement('div');
    body.style.whiteSpace = 'pre-wrap';
    body.innerHTML = msg.body_html || msg.body;

    bubble.appendChild(meta);
    bubble.appendChild(body);
    wrapper.appendChild(bubble);
    messageList.appendChild(wrapper);
  }

  function getLastMessageId() {
    const messages = messageList.querySelectorAll('[data-message-id]');
    if (!messages.length) return 0;
    return parseInt(messages[messages.length - 1].dataset.messageId, 10);
  }

  async function pollConversationList() {
    try {
      const response = await fetch('{% url "messages_poll" %}', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!response.ok) return;
      const data = await response.json();
      renderConversations(data.items || []);
    } catch (err) {
      return;
    }
  }

  async function pollMessages() {
    const lastId = getLastMessageId();
    try {
      const response = await fetch(`/messages/${conversationId}/poll/?after=${lastId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!response.ok) return;
      const data = await response.json();
      (data.messages || []).forEach(appendMessage);
      if (typeof data.typing_active !== 'undefined' && typingIndicator) {
        typingIndicator.textContent = data.typing_active ? '–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶' : '';
      }
      if (data.messages && data.messages.length) {
        messageList.scrollTop = messageList.scrollHeight;
      }
    } catch (err) {
      return;
    }
  }

  async function sendTypingPing() {
    try {
      await fetch(`/messages/${conversationId}/typing/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCsrfToken(),
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
    } catch (err) {
      return;
    }
  }

  let typingTimeout = null;
  const textarea = document.querySelector('textarea[name="body"]');
  if (textarea) {
    textarea.addEventListener('input', () => {
      if (typingTimeout) return;
      typingTimeout = setTimeout(() => { typingTimeout = null; }, 1500);
      sendTypingPing();
    });
  }

  setupEmojiPicker(document.querySelector('.tg-composer'));

  setInterval(pollConversationList, 12000);
  setInterval(pollMessages, 3000);
</script>
{% endblock %}
