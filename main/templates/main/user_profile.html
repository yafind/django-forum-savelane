{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ profile_user.username }} – {{ block.super }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Заголовок профиля -->
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold">{{ profile_user.username }}</h1>
    <p class="text-muted mb-0">
      <small>Участник с {{ profile_user.date_joined|date:"d.m.Y" }}</small>
    </p>
  </div>

  <!-- Аватар -->
      <div class="text-center mb-5">
    {% with avatar_url=profile_user.profile.avatar_url %}
      <div class="d-inline-block p-2 bg-light rounded-circle">
        <img 
          src="{{ avatar_url }}"
          alt="Аватар {{ profile_user.username }}"
          class="rounded-circle border border-3 border-white shadow-sm"
          width="140"
          height="140"
          loading="lazy"
          onerror="this.onerror=null; this.src='{% static "images/default-avatar.png" %}';"
        >
      </div>
    {% endwith %}
  </div>

  <!-- Статистика -->
  <div class="row justify-content-center g-4 mb-5">
    <div class="col-md-5">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
          <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mb-3" style="width: 72px; height: 72px;">
            <span class="fs-3 fw-bold text-primary">{{ post_count }}</span>
          </div>
          <h5 class="card-title mb-0 text-white">Сообщений</h5>
        </div>
      </div>
    </div>
    <div class="col-md-5">
      <div class="card text-center shadow-sm h-100">
        <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
          <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mb-3" style="width: 72px; height: 72px;">
            <span class="fs-3 fw-bold text-success">{{ thread_count }}</span>
          </div>
          <h5 class="card-title mb-0 text-white">Тем создано</h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Действия -->
  <div class="text-center">
    <div class="d-flex flex-wrap justify-content-center gap-2">
      {% if user.is_authenticated and user.id != profile_user.id %}
        <a href="{% url 'start_conversation' profile_user.id %}" class="btn btn-outline-primary btn-sm px-3" aria-label="Написать сообщение">
          <i class="fas fa-envelope me-1" aria-hidden="true"></i> Написать
        </a>
      {% endif %}
      <a href="{% url 'update_avatar' %}" class="btn btn-outline-primary btn-sm px-3" aria-label="Изменить аватар">
        <i class="fas fa-camera me-1" aria-hidden="true"></i> Изменить аватар
      </a>
      <a href="{% url 'section_list' %}" class="btn btn-outline-secondary btn-sm px-3" aria-label="На главную">
        <i class="fas fa-arrow-left me-1" aria-hidden="true"></i> На главную
      </a>
      {% if user.is_authenticated %}
        <form method="post" action="{% url 'logout' %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger btn-sm">
        <i class="fas fa-sign-out-alt me-1" aria-hidden="true"></i> Выйти
        </button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- Сообщения в темах -->
  <div class="card mt-4">
    <div class="card-header bg-light">
      <h2 class="h5 mb-0">Последние сообщения в темах</h2>
    </div>
    <div class="list-group list-group-flush">
      {% if recent_posts %}
        {% for post in recent_posts %}
          <a href="{% url 'post_list' post.thread.id %}" class="list-group-item list-group-item-action">
            <div class="d-flex justify-content-between">
              <div>
                <strong class="d-block">{{ post.thread.title }}</strong>
                <small class="text-muted">{{ post.thread.subsection.section.title }} → {{ post.thread.subsection.title }}</small>
              </div>
              <div class="text-muted small">{{ post.created_at|date:"d.m.Y H:i" }}</div>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <div class="list-group-item text-muted">Сообщений в темах пока нет.</div>
      {% endif %}
    </div>
  </div>

  <!-- Стена -->
  <div class="card mt-4">
    <div class="card-header bg-light d-flex align-items-center justify-content-between">
      <h2 class="h5 mb-0">Стена</h2>
      <span class="text-muted small">Записи {{ profile_user.username }}</span>
    </div>
    <div class="card-body">
      {% if user.is_authenticated %}
        <form method="post" action="{% url 'wall_post_create' profile_user.id %}" class="mb-4">
          {% csrf_token %}
          {{ wall_form.body }}
          <div class="d-flex justify-content-end mt-3">
            <button type="submit" class="btn btn-primary rounded-pill px-4">Опубликовать</button>
          </div>
        </form>
      {% else %}
        <div class="text-muted mb-4">Войдите, чтобы оставить запись.</div>
      {% endif %}

      {% if wall_posts %}
        <div class="d-grid gap-3">
          {% for item in wall_posts %}
            <div class="card bg-light border-0">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <strong class="text-white">{{ item.author.username }}</strong>
                    <div class="text-muted small">{{ item.created_at|date:"d.m.Y H:i" }}</div>
                  </div>
                  {% if user.is_authenticated %}
                    {% if user.id == item.author_id or user.is_staff %}
                    <div class="d-flex gap-2">
                      <a href="{% url 'wall_post_edit' profile_user.id item.id %}" class="btn btn-sm btn-outline-secondary rounded-pill px-3">Редактировать</a>
                      <form method="post" action="{% url 'wall_post_delete' profile_user.id item.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3">Удалить</button>
                      </form>
                    </div>
                    {% endif %}
                  {% endif %}
                </div>
                <div class="mb-3 text-white">{{ item.body }}</div>

                <div class="ms-3">
                  {% for comment in item.comments.all %}
                    <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong>{{ comment.author.username }}</strong>
                          <span class="text-muted small">• {{ comment.created_at|date:"d.m.Y H:i" }}</span>
                        </div>
                        {% if user.is_authenticated %}
                          {% if user.id == comment.author_id or user.is_staff %}
                          <div class="d-flex gap-2">
                            <a href="{% url 'wall_comment_edit' profile_user.id item.id comment.id %}" class="btn btn-sm btn-outline-secondary rounded-pill px-2">Править</a>
                            <form method="post" action="{% url 'wall_comment_delete' profile_user.id item.id comment.id %}">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-2">Удалить</button>
                            </form>
                          </div>
                          {% endif %}
                        {% endif %}
                      </div>
                      <div class="text-muted">{{ comment.body }}</div>
                    </div>
                  {% empty %}
                    <div class="text-muted small">Комментариев пока нет.</div>
                  {% endfor %}

                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'wall_comment_create' profile_user.id item.id %}" class="mt-3">
                      {% csrf_token %}
                      <textarea name="body" rows="2" class="form-control" placeholder="Оставьте комментарий..."></textarea>
                      <div class="d-flex justify-content-end mt-2">
                        <button type="submit" class="btn btn-sm btn-outline-primary rounded-pill px-3">Ответить</button>
                      </div>
                    </form>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">Пока нет записей на стене.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}